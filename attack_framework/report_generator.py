"""
Í≥µÍ≤© Í≤∞Í≥º Î≥¥Í≥†ÏÑú ÏÉùÏÑ±
ÌÜµÌï© Í≥µÍ≤© Í≤∞Í≥ºÎ•º JSON Î∞è HTML ÌòïÌÉúÎ°ú Î≥¥Í≥†ÏÑú ÏÉùÏÑ±
"""

import json
import os
from datetime import datetime
from typing import List, Dict, Any, Optional
from pathlib import Path

from .attack_executor import CombinedAttackResult, AttackStrategy
from .attack_templates import TemplateAttackResult
from .feedback_loop import FailureAnalysis


class ReportGenerator:
    """Í≥µÍ≤© Í≤∞Í≥º Î≥¥Í≥†ÏÑú ÏÉùÏÑ±Í∏∞"""
    
    def __init__(self):
        self.reports_dir = Path("./reports")
        self.reports_dir.mkdir(exist_ok=True)
        
    async def generate_full_report(self, 
                                 result: CombinedAttackResult,
                                 failure_analyses: List[FailureAnalysis] = None,
                                 metadata: Dict[str, Any] = None) -> Dict[str, str]:
        """Ï†ÑÏ≤¥ Î≥¥Í≥†ÏÑú ÏÉùÏÑ± (JSON + HTML)"""
        
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        
        # Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ
        if metadata is None:
            metadata = {}
            
        report_data = self._prepare_report_data(result, failure_analyses, metadata, timestamp)
        
        # JSON Î≥¥Í≥†ÏÑú ÏÉùÏÑ±
        json_file = await self._generate_json_report(report_data, timestamp)
        
        # HTML Î≥¥Í≥†ÏÑú ÏÉùÏÑ±
        html_file = await self._generate_html_report(report_data, timestamp)
        
        print(f"\nüìÑ Î≥¥Í≥†ÏÑú ÏÉùÏÑ± ÏôÑÎ£å:")
        print(f"  JSON: {json_file}")
        print(f"  HTML: {html_file}")
        
        return {
            "json": json_file,
            "html": html_file,
            "timestamp": timestamp
        }
        
    def _prepare_report_data(self, 
                           result: CombinedAttackResult,
                           failure_analyses: List[FailureAnalysis],
                           metadata: Dict[str, Any],
                           timestamp: str) -> Dict[str, Any]:
        """Î≥¥Í≥†ÏÑú Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ"""
        
        # Í∏∞Î≥∏ Î©îÌÉÄÎç∞Ïù¥ÌÑ∞
        report_metadata = {
            "timestamp": timestamp,
            "generated_at": datetime.now().isoformat(),
            "strategy": result.strategy.value,
            "framework_version": "1.0.0",
            **metadata
        }
        
        # Ï†ÑÏ≤¥ ÌÜµÍ≥Ñ
        overall_stats = {
            "total_attempts": result.total_attempts,
            "total_success": result.total_success,
            "success_rate": result.success_rate,
            "execution_time": result.execution_time,
            "enhanced_attacks": result.enhanced_attacks
        }
        
        # ÌÖúÌîåÎ¶ø Í≥µÍ≤© Í≤∞Í≥º
        template_data = {
            "total_templates": len(result.template_results),
            "successful_templates": sum(1 for r in result.template_results if r.success),
            "failed_templates": sum(1 for r in result.template_results if not r.success),
            "results": []
        }
        
        for template_result in result.template_results:
            template_data["results"].append({
                "template_id": template_result.template_id,
                "prompt": template_result.template_prompt,
                "response": template_result.response,
                "success": template_result.success,
                "indicators_found": template_result.indicators_found,
                "execution_time": template_result.execution_time,
                "category": template_result.category.value,
                "cvss_score": template_result.cvss_score,
                "enhanced_with_thinking": getattr(template_result, 'enhanced_with_thinking', False)
            })
            
        # LLM-to-LLM Í≥µÍ≤© Í≤∞Í≥º
        llm_to_llm_data = {
            "total_iterations": len(result.llm_to_llm_results),
            "successful_iterations": sum(1 for r in result.llm_to_llm_results if r.success),
            "results": []
        }
        
        for llm_result in result.llm_to_llm_results:
            llm_to_llm_data["results"].append({
                "phase": llm_result.phase.value,
                "prompt": llm_result.prompt,
                "response": llm_result.response,
                "success": llm_result.success,
                "indicators_found": llm_result.indicators_found,
                "execution_time": llm_result.execution_time,
                "cvss_score": llm_result.cvss_score
            })
            
        # Ïã§Ìå® Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞
        failure_data = None
        if failure_analyses:
            failure_data = {
                "total_analyzed": len(failure_analyses),
                "analyses": []
            }
            
            for analysis in failure_analyses:
                failure_data["analyses"].append({
                    "template_id": analysis.template_id,
                    "failure_reason": analysis.failure_reason.value,
                    "confidence": analysis.confidence,
                    "evidence_keywords": analysis.evidence_keywords,
                    "improvement_suggestions": analysis.improvement_suggestions,
                    "recommended_approach": analysis.recommended_approach
                })
                
        # CVSS Ï†êÏàò Î∂ÑÏÑù
        cvss_analysis = self._analyze_cvss_scores(result)
        
        return {
            "metadata": report_metadata,
            "overall_statistics": overall_stats,
            "template_attacks": template_data,
            "llm_to_llm_attacks": llm_to_llm_data,
            "failure_analysis": failure_data,
            "cvss_analysis": cvss_analysis,
            "summary": self._generate_summary(result, failure_analyses)
        }
        
    async def _generate_json_report(self, report_data: Dict[str, Any], timestamp: str) -> str:
        """JSON Î≥¥Í≥†ÏÑú ÏÉùÏÑ±"""
        
        filename = f"report_{timestamp}.json"
        filepath = self.reports_dir / filename
        
        with open(filepath, 'w', encoding='utf-8') as f:
            json.dump(report_data, f, indent=2, ensure_ascii=False)
            
        return str(filepath)
        
    async def _generate_html_report(self, report_data: Dict[str, Any], timestamp: str) -> str:
        """HTML Î≥¥Í≥†ÏÑú ÏÉùÏÑ±"""
        
        filename = f"report_{timestamp}.html"
        filepath = self.reports_dir / filename
        
        html_content = self._create_html_template(report_data)
        
        with open(filepath, 'w', encoding='utf-8') as f:
            f.write(html_content)
            
        return str(filepath)
        
    def _create_html_template(self, data: Dict[str, Any]) -> str:
        """HTML Î≥¥Í≥†ÏÑú ÌÖúÌîåÎ¶ø ÏÉùÏÑ±"""
        
        metadata = data["metadata"]
        stats = data["overall_statistics"]
        template_data = data["template_attacks"]
        llm_data = data["llm_to_llm_attacks"]
        failure_data = data.get("failure_analysis")
        cvss_data = data["cvss_analysis"]
        summary = data["summary"]
        
        html = f"""<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP ÌîÑÎ°¨ÌîÑÌä∏ Ï£ºÏûÖ Í≥µÍ≤© Î≥¥Í≥†ÏÑú - {metadata['timestamp']}</title>
    <style>
        body {{
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }}
        .container {{
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }}
        h1, h2, h3 {{
            color: #333;
            border-bottom: 2px solid #007acc;
            padding-bottom: 10px;
        }}
        .stats-grid {{
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }}
        .stat-card {{
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #007acc;
        }}
        .stat-value {{
            font-size: 2em;
            font-weight: bold;
            color: #007acc;
        }}
        .stat-label {{
            color: #666;
            font-size: 0.9em;
        }}
        .success {{
            color: #28a745;
        }}
        .failure {{
            color: #dc3545;
        }}
        .warning {{
            color: #ffc107;
        }}
        .attack-result {{
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #ddd;
        }}
        .attack-success {{
            background: #d4edda;
            border-left-color: #28a745;
        }}
        .attack-failure {{
            background: #f8d7da;
            border-left-color: #dc3545;
        }}
        .prompt-text {{
            background: #f1f3f4;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
        }}
        .response-text {{
            background: #e8f4f8;
            padding: 10px;
            border-radius: 4px;
            font-size: 0.9em;
            margin: 10px 0;
            max-height: 150px;
            overflow-y: auto;
        }}
        .indicators {{
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin: 10px 0;
        }}
        .indicator {{
            background: #007acc;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.8em;
        }}
        .failure-analysis {{
            background: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }}
        .cvss-score {{
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
        }}
        .cvss-low {{ background: #28a745; }}
        .cvss-medium {{ background: #ffc107; color: black; }}
        .cvss-high {{ background: #fd7e14; }}
        .cvss-critical {{ background: #dc3545; }}
        table {{
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }}
        th, td {{
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }}
        th {{
            background-color: #f8f9fa;
            font-weight: bold;
        }}
        .expandable {{
            cursor: pointer;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
        }}
        .expandable:hover {{
            background: #e9ecef;
        }}
        .content {{
            display: none;
            padding: 10px;
            border-left: 3px solid #007acc;
            margin-left: 20px;
        }}
        .content.show {{
            display: block;
        }}
    </style>
    <script>
        function toggleContent(id) {{
            const content = document.getElementById(id);
            content.classList.toggle('show');
        }}
    </script>
</head>
<body>
    <div class="container">
        <h1>üéØ MCP Í∏∞Î∞ò ÌîÑÎ°¨ÌîÑÌä∏ Ï£ºÏûÖ Í≥µÍ≤© Î≥¥Í≥†ÏÑú</h1>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value">{stats['total_attempts']}</div>
                <div class="stat-label">Ï¥ù Í≥µÍ≤© ÏãúÎèÑ</div>
            </div>
            <div class="stat-card">
                <div class="stat-value success">{stats['total_success']}</div>
                <div class="stat-label">ÏÑ±Í≥µÌïú Í≥µÍ≤©</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{stats['success_rate']:.1f}%</div>
                <div class="stat-label">Ï†ÑÏ≤¥ ÏÑ±Í≥µÎ•†</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{stats['execution_time']:.1f}Ï¥à</div>
                <div class="stat-label">Ïã§Ìñâ ÏãúÍ∞Ñ</div>
            </div>
        </div>
        
        <h2>üìä ÏöîÏïΩ</h2>
        <div class="prompt-text">{summary}</div>
        
        <h2>üéØ ÌÖúÌîåÎ¶ø Í∏∞Î∞ò Í≥µÍ≤© Í≤∞Í≥º</h2>
        <p><strong>ÏÑ±Í≥µ:</strong> <span class="success">{template_data['successful_templates']}</span> / 
           <strong>Ïã§Ìå®:</strong> <span class="failure">{template_data['failed_templates']}</span> / 
           <strong>Ï†ÑÏ≤¥:</strong> {template_data['total_templates']}</p>
"""

        # ÌÖúÌîåÎ¶ø Í≥µÍ≤© Í≤∞Í≥º ÏÉÅÏÑ∏
        for i, result in enumerate(template_data['results']):
            status_class = "attack-success" if result['success'] else "attack-failure"
            status_text = "‚úÖ ÏÑ±Í≥µ" if result['success'] else "‚ùå Ïã§Ìå®"
            
            # Sequential Thinking Í∞úÏÑ† Ïó¨Î∂Ä ÌëúÏãú
            enhancement_badge = ""
            if result.get('enhanced_with_thinking', False):
                enhancement_badge = " <span style='background: #17a2b8; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8em;'>ST Í∞úÏÑ†</span>"
            
            cvss_class = ""
            if result['cvss_score']:
                if result['cvss_score'] >= 9.0:
                    cvss_class = "cvss-critical"
                elif result['cvss_score'] >= 7.0:
                    cvss_class = "cvss-high"
                elif result['cvss_score'] >= 4.0:
                    cvss_class = "cvss-medium"
                else:
                    cvss_class = "cvss-low"
            
            html += f"""
        <div class="attack-result {status_class}">
            <h4>ÌÖúÌîåÎ¶ø #{result['template_id']} - {status_text}{enhancement_badge}</h4>
            <div class="expandable" onclick="toggleContent('template_{i}')">
                üìù ÌîÑÎ°¨ÌîÑÌä∏ Î≥¥Í∏∞ (ÌÅ¥Î¶≠)
            </div>
            <div id="template_{i}" class="content">
                <div class="prompt-text">{result['prompt']}</div>
            </div>
            
            <div class="expandable" onclick="toggleContent('response_{i}')">
                üìÑ ÏùëÎãµ Î≥¥Í∏∞ (ÌÅ¥Î¶≠)
            </div>
            <div id="response_{i}" class="content">
                <div class="response-text">{result['response']}</div>
            </div>
            
            {f'<div class="indicators">ÏßÄÌëú: ' + ''.join([f'<span class="indicator">{ind}</span>' for ind in result['indicators_found']]) + '</div>' if result['indicators_found'] else ''}
            
            <p><strong>Ïπ¥ÌÖåÍ≥†Î¶¨:</strong> {result['category']} | 
               <strong>Ïã§ÌñâÏãúÍ∞Ñ:</strong> {result['execution_time']:.2f}Ï¥à
               {f' | <strong>CVSS:</strong> <span class="cvss-score {cvss_class}">{result["cvss_score"]:.1f}</span>' if result['cvss_score'] else ''}</p>
        </div>
"""

        # LLM-to-LLM Í≥µÍ≤© Í≤∞Í≥º
        if llm_data['results']:
            html += f"""
        <h2>ü§ñ LLM-to-LLM Î≥¥ÏôÑ Í≥µÍ≤© Í≤∞Í≥º</h2>
        <p><strong>ÏÑ±Í≥µ:</strong> <span class="success">{llm_data['successful_iterations']}</span> / 
           <strong>Ï†ÑÏ≤¥:</strong> {llm_data['total_iterations']}</p>
"""
            
            for i, result in enumerate(llm_data['results']):
                status_class = "attack-success" if result['success'] else "attack-failure"
                status_text = "‚úÖ ÏÑ±Í≥µ" if result['success'] else "‚ùå Ïã§Ìå®"
                
                html += f"""
        <div class="attack-result {status_class}">
            <h4>{result['phase']} Îã®Í≥Ñ - {status_text}</h4>
            <div class="expandable" onclick="toggleContent('llm_prompt_{i}')">
                üìù ÏÉùÏÑ±Îêú ÌîÑÎ°¨ÌîÑÌä∏ Î≥¥Í∏∞ (ÌÅ¥Î¶≠)
            </div>
            <div id="llm_prompt_{i}" class="content">
                <div class="prompt-text">{result['prompt']}</div>
            </div>
            
            <div class="expandable" onclick="toggleContent('llm_response_{i}')">
                üìÑ ÏùëÎãµ Î≥¥Í∏∞ (ÌÅ¥Î¶≠)
            </div>
            <div id="llm_response_{i}" class="content">
                <div class="response-text">{result['response']}</div>
            </div>
            
            <p><strong>Ïã§ÌñâÏãúÍ∞Ñ:</strong> {result['execution_time']:.2f}Ï¥à
               {f' | <strong>CVSS:</strong> {result["cvss_score"]:.1f}' if result['cvss_score'] else ''}</p>
        </div>
"""

        # Ïã§Ìå® Î∂ÑÏÑù
        if failure_data:
            html += f"""
        <h2>üîç Ïã§Ìå® Î∂ÑÏÑù</h2>
        <p>Ï¥ù {failure_data['total_analyzed']}Í∞úÏùò Ïã§Ìå® ÏºÄÏù¥Ïä§ Î∂ÑÏÑù</p>
"""
            
            for analysis in failure_data['analyses']:
                html += f"""
        <div class="failure-analysis">
            <h4>ÌÖúÌîåÎ¶ø #{analysis['template_id']} Ïã§Ìå® Î∂ÑÏÑù</h4>
            <p><strong>Ïã§Ìå® ÏõêÏù∏:</strong> {analysis['failure_reason']} (Ïã†Î¢∞ÎèÑ: {analysis['confidence']:.2f})</p>
            <p><strong>Ï¶ùÍ±∞ ÌÇ§ÏõåÎìú:</strong> {', '.join(analysis['evidence_keywords'])}</p>
            <p><strong>Í∂åÏû• Ï†ëÍ∑ºÎ≤ï:</strong> {analysis['recommended_approach']}</p>
            <div class="expandable" onclick="toggleContent('suggestions_{analysis["template_id"]}')">
                üí° Í∞úÏÑ† Ï†úÏïà Î≥¥Í∏∞ (ÌÅ¥Î¶≠)
            </div>
            <div id="suggestions_{analysis['template_id']}" class="content">
                <ul>
                    {''.join([f'<li>{suggestion}</li>' for suggestion in analysis['improvement_suggestions']])}
                </ul>
            </div>
        </div>
"""

        # CVSS Î∂ÑÏÑù
        html += f"""
        <h2>üõ°Ô∏è CVSS Î≥¥Ïïà Ï†êÏàò Î∂ÑÏÑù</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value">{cvss_data['average_score']:.1f}</div>
                <div class="stat-label">ÌèâÍ∑† CVSS Ï†êÏàò</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{cvss_data['max_score']:.1f}</div>
                <div class="stat-label">ÏµúÍ≥† CVSS Ï†êÏàò</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{cvss_data['critical_count']}</div>
                <div class="stat-label">ÏπòÎ™ÖÏ†Å Ï∑®ÏïΩÏ†ê</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{cvss_data['high_count']}</div>
                <div class="stat-label">ÎÜíÏùÄ ÏúÑÌóòÎèÑ</div>
            </div>
        </div>
        
        <h2>üìã Î©îÌÉÄÎç∞Ïù¥ÌÑ∞</h2>
        <table>
            <tr><th>Ìï≠Î™©</th><th>Í∞í</th></tr>
            <tr><td>ÏÉùÏÑ± ÏãúÍ∞Ñ</td><td>{metadata['generated_at']}</td></tr>
            <tr><td>Í≥µÍ≤© Ï†ÑÎûµ</td><td>{metadata['strategy']}</td></tr>
            <tr><td>ÌîÑÎ†àÏûÑÏõåÌÅ¨ Î≤ÑÏ†Ñ</td><td>{metadata['framework_version']}</td></tr>
        </table>
        
        <footer style="margin-top: 50px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; text-align: center;">
            <p>MCP Í∏∞Î∞ò ÌîÑÎ°¨ÌîÑÌä∏ Ï£ºÏûÖ Í≥µÍ≤© ÌîÑÎ†àÏûÑÏõåÌÅ¨ - Î≥¥Ïïà Ïó∞Íµ¨ Î™©Ï†ÅÏúºÎ°úÎßå ÏÇ¨Ïö©</p>
        </footer>
    </div>
</body>
</html>"""

        return html
        
    def _analyze_cvss_scores(self, result: CombinedAttackResult) -> Dict[str, Any]:
        """CVSS Ï†êÏàò Î∂ÑÏÑù"""
        
        all_scores = []
        
        # ÌÖúÌîåÎ¶ø Í≥µÍ≤© Ï†êÏàò ÏàòÏßë
        for template_result in result.template_results:
            if template_result.cvss_score:
                all_scores.append(template_result.cvss_score)
                
        # LLM-to-LLM Í≥µÍ≤© Ï†êÏàò ÏàòÏßë
        for llm_result in result.llm_to_llm_results:
            if llm_result.cvss_score:
                all_scores.append(llm_result.cvss_score)
                
        if not all_scores:
            return {
                "average_score": 0.0,
                "max_score": 0.0,
                "min_score": 0.0,
                "critical_count": 0,
                "high_count": 0,
                "medium_count": 0,
                "low_count": 0
            }
            
        return {
            "average_score": sum(all_scores) / len(all_scores),
            "max_score": max(all_scores),
            "min_score": min(all_scores),
            "critical_count": sum(1 for s in all_scores if s >= 9.0),
            "high_count": sum(1 for s in all_scores if 7.0 <= s < 9.0),
            "medium_count": sum(1 for s in all_scores if 4.0 <= s < 7.0),
            "low_count": sum(1 for s in all_scores if 0.1 <= s < 4.0)
        }
        
    def _generate_summary(self, result: CombinedAttackResult, failure_analyses: List[FailureAnalysis]) -> str:
        """Í≥µÍ≤© Í≤∞Í≥º ÏöîÏïΩ ÏÉùÏÑ±"""
        
        strategy_desc = {
            AttackStrategy.TEMPLATE_ONLY: "ÌÖúÌîåÎ¶ø Í∏∞Î∞ò Í≥µÍ≤©Îßå ÏÇ¨Ïö©",
            AttackStrategy.LLM_TO_LLM_ONLY: "LLM-to-LLM Í≥µÍ≤©Îßå ÏÇ¨Ïö©", 
            AttackStrategy.HYBRID: "ÌïòÏù¥Î∏åÎ¶¨Îìú Í≥µÍ≤© (ÌÖúÌîåÎ¶ø + LLM-to-LLM)"
        }
        
        summary = f"""
Í≥µÍ≤© Ï†ÑÎûµ: {strategy_desc.get(result.strategy, result.strategy.value)}

Ï†ÑÏ≤¥ Í≤∞Í≥º:
- Ï¥ù {result.total_attempts}Î≤àÏùò Í≥µÍ≤© ÏãúÎèÑ Ï§ë {result.total_success}Î≤à ÏÑ±Í≥µ (ÏÑ±Í≥µÎ•†: {result.success_rate:.1f}%)
- Ïã§Ìñâ ÏãúÍ∞Ñ: {result.execution_time:.1f}Ï¥à

Îã®Í≥ÑÎ≥Ñ Í≤∞Í≥º:
- ÌÖúÌîåÎ¶ø Í≥µÍ≤©: {len(result.template_results)}Î≤à ÏãúÎèÑ, {sum(1 for r in result.template_results if r.success)}Î≤à ÏÑ±Í≥µ
- LLM-to-LLM Î≥¥ÏôÑ: {len(result.llm_to_llm_results)}Î≤à ÏãúÎèÑ, {sum(1 for r in result.llm_to_llm_results if r.success)}Î≤à ÏÑ±Í≥µ
- Î≥¥ÏôÑÏúºÎ°ú Î≥µÍµ¨Îêú Í≥µÍ≤©: {result.enhanced_attacks}Í∞ú
"""

        if failure_analyses:
            most_common_failure = max(
                set(a.failure_reason.value for a in failure_analyses),
                key=lambda r: sum(1 for a in failure_analyses if a.failure_reason.value == r)
            )
            summary += f"\nÏ£ºÏöî Ïã§Ìå® ÏõêÏù∏: {most_common_failure}"
            
        return summary.strip() 